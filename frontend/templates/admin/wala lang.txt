from flask import Blueprint, session, render_template, flash, redirect, url_for
from ...utils.decorators import role_required
from database.database import get_db_connection

cart_bp = Blueprint(
    "cart", __name__, template_folder="../../../frontend/templates/client"
)


@cart_bp.route("/client/cart")
@role_required("user")
def cart():
    user_id = session.get("user_id")
    if not user_id:
        flash("You must be logged in to checkout.", "error")
        return redirect(url_for("login.login"))
    user_id = session.get("user_id")
    db = get_db_connection()
    cursor = db.cursor(dictionary=True)

    # Orders
    cursor.execute("SELECT * FROM orders WHERE user_id = %s", (user_id,))
    orders = cursor.fetchall()

    # Order items
    order_items = {}
    for order in orders:
        cursor.execute(
            """
            SELECT oi.*, p.name
            FROM order_items oi
            JOIN products p ON oi.product_id = p.id
            WHERE oi.order_id = %s
        """,
            (order["id"],),
        )
        order_items[order["id"]] = cursor.fetchall()

    # Purchase history
    cursor.execute(
        "SELECT * FROM purchase_history WHERE user_id = %s ORDER BY received_at DESC",
        (user_id,),
    )
    purchases = cursor.fetchall()

    cursor.close()
    db.close()
    return render_template(
        "clientOrders.html",
        orders=orders,
        order_items=order_items,
        purchases=purchases,
    )
