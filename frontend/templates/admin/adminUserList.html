{% extends "admin/adminBase.html" %}

{% block title %} Manage Users {% endblock %}

{% block content %}
<div class="container mt-4 vh-100">
<h2 class="mb-4">List of Registered Users</h2>

<!-- Add User button -->
<button class="btn btn-dark mb-3" data-bs-toggle="modal" data-bs-target="#addUser">
    <i class="bi bi-person-plus"></i> Add User
</button>

<!-- Table -->
<div class="container mt-4">
    <table id="userTable" class="table table-bordered table-striped align-middle">
        <thead class="table-dark">
            <tr>
                <th>No.</th>
                <th>Firstname</th>
                <th>Lastname</th>
                <th>Username</th>
                <th>Time Created</th>
                <th>Role</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ u.firstname.capitalize() }}</td>
                <td>{{ u.lastname.capitalize() }}</td>
                <td>{{ u.username.capitalize() }}</td>
                <td>{{ u.created_at }}</td>
                <td>
                    {% if u.is_admin == 'admin' %}
                    <span class="badge bg-success">Admin</span>
                    {% elif u.is_admin == 'user' %}
                    <span class="badge bg-secondary">User</span>
                    {% else %}
                    <span class="badge bg-dark">{{ u.is_admin }}</span>
                    {% endif %}
                </td>
                <td>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editUser{{ u.id }}">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger" data-bs-toggle="modal"
                        data-bs-target="#deleteUser{{ u.id }}"><i class="bi bi-trash"></i> Delete</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUser" tabindex="-1" aria-labelledby="addUserLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header d-block bg-dark">
                <div class="w-100 text-center">
                    <img
                    src="/static/images/logo.png"
                    width="130"
                    height="50"
                    alt="Logo"
                    />
                </div>
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-2" data-bs-dismiss="modal" aria-label="Close"></button>
                <h6 class="modal-title fw-bold mt-2" id="addUserLabel">Add User</h6>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('addUser.addUser') }}">
                    <div class="mb-3">
                        <label for="firstname" class="form-label">Firstname</label>
                        <input type="text" class="form-control" id="firstname" name="firstname" required>
                    </div>
                    <div class="mb-3">
                        <label for="lastname" class="form-label">Lastname</label>
                        <input type="text" class="form-control" id="lastname" name="lastname" required>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Email / Username</label>
                        <input type="email" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="is_admin" class="form-label">User Type</label>
                        <select class="form-select" id="is_admin" name="is_admin">
                            <option value="user" selected>User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                                            <button type="submit" class="btn btn-success">Add User</button>
                                                      <button class="btn btn-secondary" data-bs-dismiss="modal">
            Cancel
          </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
{% for u in users %}
<div class="modal fade" id="editUser{{ u.id }}" tabindex="-1" aria-labelledby="editUserLabel{{ u.id }}"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header d-block bg-dark">
        <div class="w-100 text-center">
          <img
            src="/static/images/logo.png"
            width="130"
            height="50"
            alt="Logo"
          />
        </div>
        <button
          type="button"
          class="btn-close btn-close-white position-absolute top-0 end-0 m-2"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
                <h6 class="modal-title" id="editUserLabel{{ u.id }}">Edit User: {{ u.firstname.capitalize() }}</h6>
            </div>
            <div class="modal-body">
                <form method="POST" action="{{ url_for('editUser.editUser', user_id=u.id) }}">

                    <!-- Firstname -->
                    <div class="mb-3">
                        <label for="firstname{{ u.id }}" class="form-label">Firstname</label>
                        <input type="text" class="form-control" id="firstname{{ u.id }}" name="firstname"
                            value="{{ u.firstname }}" required>
                    </div>

                    <!-- Lastname -->
                    <div class="mb-3">
                        <label for="lastname{{ u.id }}" class="form-label">Lastname</label>
                        <input type="text" class="form-control" id="lastname{{ u.id }}" name="lastname"
                            value="{{ u.lastname }}" required>
                    </div>

                    <!-- Username / Email -->
                    <div class="mb-3">
                        <label for="username{{ u.id }}" class="form-label">Email / Username</label>
                        <input type="email" class="form-control" id="username{{ u.id }}" name="username"
                            value="{{ u.username }}" required>
                    </div>

                    <!-- Password -->
                    <div class="mb-3">
                        <label for="password{{ u.id }}" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password{{ u.id }}" name="password"
                            placeholder="Enter new password (leave blank to keep current)">
                    </div>

                    <!-- Role -->
                    <div class="mb-3">
                        <label for="is_admin{{ u.id }}" class="form-label">User Type</label>
                        <select class="form-control" id="is_admin{{ u.id }}" name="is_admin">
                            <option value="user" {% if u.is_admin=='user' %}selected{% endif %}>User</option>
                            <option value="admin" {% if u.is_admin=='admin' %}selected{% endif %}>Admin</option>
                        </select>
                    </div>

                    <div class="modal-footer">
 
                        <button type="submit" class="btn btn-success"><i class="bi bi-save"></i> Save changes</button>
                                               <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteUser{{ u.id }}" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header d-block bg-dark">
        <div class="w-100 text-center">
          <img
            src="/static/images/logo.png"
            width="130"
            height="50"
            alt="Logo"
          />
        </div>
        <button
          type="button"
          class="btn-close btn-close-white position-absolute top-0 end-0 m-2"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
                <h6 class="modal-title">Delete User: {{ u.firstname.capitalize() }}</h6>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this user?
            </div>
            <div class="modal-footer">
                <form action="{{ url_for('deleteUser.deleteUser', user_id=u.id) }}" method="POST">

                    <button type="submit" class="btn btn-danger">Delete</button>
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block extra_script %}

<script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>

<script src="{{ url_for('static', filename='bootstrap.bundle.min.js') }}"></script>

<script src="{{ url_for('static', filename='datatables/js/datatables.min.js') }}"></script>

<script>
    // Init DataTable
    $(document).ready(function () {
        $('#userTable').DataTable({
            pageLength: 5,
            lengthMenu: [5, 10, 25, 50],
            ordering: true,
            searching: true,
            language: {
                search: '<i class="bi bi-search"></i>',
                searchPlaceholder: "Search users..."
            }
        });
    });
    // Auto-dismiss flash messages after 4 seconds
    setTimeout(() => {
        const alerts = document.querySelectorAll(".alert");
        alerts.forEach((alert) => {
            let bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        });
    }, 4000); // 4000ms = 4 seconds
    document.addEventListener("DOMContentLoaded", () => {
        const toastElList = document.querySelectorAll(".toast");
        toastElList.forEach((toastEl) => {
            const toast = new bootstrap.Toast(toastEl, {
                delay: 3000, // hide after 3s
                autohide: true, // make sure autohide is enabled
            });
            toast.show();
        });
    });
</script>
{% endblock %}